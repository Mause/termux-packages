From a9e932ca67c6062c6098b11712954690c9cee805 Mon Sep 17 00:00:00 2001
From: pfg <pfg@pfg.pw>
Date: Wed, 29 Oct 2025 14:36:13 -0700
Subject: [PATCH] reapply other changes

---
 lib/std/Build/Module.zig       |   4 +
 lib/std/Build/Step/Compile.zig |  15 +++
 src/Compilation.zig            |  48 ++++++++-
 src/Compilation/Config.zig     |   3 +
 src/Package/Module.zig         |  12 +++
 src/arch/x86_64/CodeGen.zig    |  21 +++-
 src/codegen/llvm.zig           |  26 ++++-
 src/codegen/llvm/bindings.zig  |   4 +
 src/link.zig                   |   3 +
 src/link/Coff.zig              |   1 +
 src/link/Elf.zig               |  29 +++++-
 src/link/MachO.zig             |  31 +++++-
 src/main.zig                   |  25 +++++
 src/zig_llvm.cpp               | 172 +++++++++++++++++++++++++++++----
 src/zig_llvm.h                 |   5 +
 15 files changed, 364 insertions(+), 35 deletions(-)

diff --git a/lib/std/Build/Module.zig b/lib/std/Build/Module.zig
index 6f7892483dfc..48f69223fe57 100644
--- a/lib/std/Build/Module.zig
+++ b/lib/std/Build/Module.zig
@@ -34,6 +34,7 @@ omit_frame_pointer: ?bool,
 error_tracing: ?bool,
 link_libc: ?bool,
 link_libcpp: ?bool,
+no_init_undefined: ?bool,
 no_builtin: ?bool,
 
 /// Symbols to be exported when compiling to WebAssembly.
@@ -257,6 +258,7 @@ pub const CreateOptions = struct {
     /// more difficult to obtain stack traces. Has target-dependent effects.
     omit_frame_pointer: ?bool = null,
     error_tracing: ?bool = null,
+    no_init_undefined: ?bool = null,
     no_builtin: ?bool = null,
 };
 
@@ -304,6 +306,7 @@ pub fn init(
                 .red_zone = options.red_zone,
                 .omit_frame_pointer = options.omit_frame_pointer,
                 .error_tracing = options.error_tracing,
+                .no_init_undefined = options.no_init_undefined,
                 .export_symbol_names = &.{},
                 .no_builtin = options.no_builtin,
             };
@@ -555,6 +558,7 @@ pub fn appendZigProcessFlags(
     try addFlag(zig_args, m.sanitize_address, "-fsanitize-address", "-fno-sanitize-address");
     try addFlag(zig_args, m.fuzz, "-ffuzz", "-fno-fuzz");
     try addFlag(zig_args, m.valgrind, "-fvalgrind", "-fno-valgrind");
+    try addFlag(zig_args, m.no_init_undefined, "-fno-init-undefined", "-finit-undefined");
     try addFlag(zig_args, m.pic, "-fPIC", "-fno-PIC");
     try addFlag(zig_args, m.red_zone, "-mred-zone", "-mno-red-zone");
     try addFlag(zig_args, m.no_builtin, "-fno-builtin", "-fbuiltin");
diff --git a/lib/std/Build/Step/Compile.zig b/lib/std/Build/Step/Compile.zig
index b64ce59778f2..fc23d2da389a 100644
--- a/lib/std/Build/Step/Compile.zig
+++ b/lib/std/Build/Step/Compile.zig
@@ -157,6 +157,15 @@ headerpad_max_install_names: bool = false,
 /// (Darwin) Remove dylibs that are unreachable by the entry point or exported symbols.
 dead_strip_dylibs: bool = false,
 
+/// Number of threads to use for LLVM backend code generation.
+/// 0 means single-threaded (default). > 1 enables parallel codegen.
+/// When enabled, outputs multiple .o files: filename.0.o, filename.1.o, etc.
+llvm_codegen_threads: u32 = 0,
+
+/// Skip linker step for build-obj - outputs raw LLVM object file(s).
+/// Saves time by avoiding parse/resolve/write cycle.
+no_link_obj: bool = false,
+
 /// (Darwin) Force load all members of static archives that implement an Objective-C class or category
 force_load_objc: bool = false,
 
@@ -1520,6 +1529,12 @@ fn getZigArgs(compile: *Compile, fuzz: bool) ![][]const u8 {
     if (compile.link_data_sections) {
         try zig_args.append("-fdata-sections");
     }
+    if (compile.llvm_codegen_threads > 0) {
+        try zig_args.append(b.fmt("--llvm-codegen-threads={d}", .{compile.llvm_codegen_threads}));
+    }
+    if (compile.no_link_obj) {
+        try zig_args.append("--no-link");
+    }
     if (compile.link_gc_sections) |x| {
         try zig_args.append(if (x) "--gc-sections" else "--no-gc-sections");
     }
