From 88e225f0c1a61bc03448f25f9957195c85b9bf0d Mon Sep 17 00:00:00 2001
From: Elliana May <me@mause.me>
Date: Thu, 9 Oct 2025 13:38:24 +0800
Subject: [PATCH 1/2] apply partial patch

---
 src/main/cpp/BUILD | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/main/cpp/BUILD b/src/main/cpp/BUILD
index dd3bc4039771c7..418ffad053bca7 100644
--- a/src/main/cpp/BUILD
+++ b/src/main/cpp/BUILD
@@ -91,7 +91,7 @@ cc_library(
 )
 
 cc_binary(
-    name = "client",
+    name = "client_orig",
     srcs = [
         "blaze.cc",
         "blaze.h",
@@ -141,6 +141,21 @@ cc_binary(
     ],
 )
 
+genrule(
+    name = "client_cleaner",
+    srcs = [
+        ":client_orig",
+    ],
+    outs = ["client"],
+    cmd = "\n".join([
+        "TEMP_FILE=\"$$(mktemp -t bazel.XXXXXXXX)\"",
+        "cp \"$(location :client_orig)\" \"$${TEMP_FILE}\"",
+        "termux-elf-cleaner --api-level=24 \"$${TEMP_FILE}\"",
+        "cp \"$${TEMP_FILE}\" \"$@\"",
+        "rm \"$${TEMP_FILE}\"",
+    ]),
+)
+
 cc_library(
     name = "option_processor",
     srcs = [

From 2f6a30a6ecc843f7f4d18bb0ad2dc0d247e143c4 Mon Sep 17 00:00:00 2001
From: Elliana May <me@mause.me>
Date: Thu, 9 Oct 2025 13:43:56 +0800
Subject: [PATCH 2/2] patch src/main/tools/BUILD

---
 src/main/tools/BUILD | 68 +++++++++++++++++++++++++++++++++++++++++---
 1 file changed, 64 insertions(+), 4 deletions(-)

diff --git a/src/main/tools/BUILD b/src/main/tools/BUILD
index c1d3db9174b97d..9290c20aee8080 100644
--- a/src/main/tools/BUILD
+++ b/src/main/tools/BUILD
@@ -1,13 +1,28 @@
 package(default_visibility = ["//src:__subpackages__"])
 
 cc_binary(
-    name = "daemonize",
+    name = "daemonize_orig",
     srcs = ["daemonize.cc"],
     deps = [
         ":process-tools",
     ],
 )
 
+genrule(
+    name = "daemonize_cleaner",
+    srcs = [
+        ":daemonize_orig",
+    ],
+    outs = ["daemonize"],
+    cmd = "\n".join([
+        "TEMP_FILE=\"$$(mktemp -t bazel.XXXXXXXX)\"",
+        "cp \"$(location :daemonize_orig)\" \"$${TEMP_FILE}\"",
+        "termux-elf-cleaner --api-level=24 \"$${TEMP_FILE}\"",
+        "cp \"$${TEMP_FILE}\" \"$@\"",
+        "rm \"$${TEMP_FILE}\"",
+    ]),
+)
+
 cc_library(
     name = "logging",
     srcs = ["logging.cc"],
@@ -29,7 +44,7 @@ cc_library(
 )
 
 cc_binary(
-    name = "process-wrapper",
+    name = "process-wrapper_orig",
     srcs = select({
         "//src/conditions:windows": ["process-wrapper-windows.cc"],
         "//conditions:default": [
@@ -59,8 +74,23 @@ cc_binary(
     }),
 )
 
+genrule(
+    name = "process-wrapper_cleaner",
+    srcs = [
+        ":process-wrapper_orig",
+    ],
+    outs = ["process-wrapper"],
+    cmd = "\n".join([
+        "TEMP_FILE=\"$$(mktemp -t bazel.XXXXXXXX)\"",
+        "cp \"$(location :process-wrapper_orig)\" \"$${TEMP_FILE}\"",
+        "termux-elf-cleaner --api-level=24 \"$${TEMP_FILE}\"",
+        "cp \"$${TEMP_FILE}\" \"$@\"",
+        "rm \"$${TEMP_FILE}\"",
+    ]),
+)
+
 cc_binary(
-    name = "build-runfiles",
+    name = "build-runfiles_orig",
     srcs = select({
         "//src/conditions:windows": ["build-runfiles-windows.cc"],
         "//conditions:default": ["build-runfiles.cc"],
@@ -71,8 +101,23 @@ cc_binary(
     }),
 )
 
+genrule(
+    name = "build-runfiles_cleaner",
+    srcs = [
+        ":build-runfiles_orig",
+    ],
+    outs = ["build-runfiles"],
+    cmd = "\n".join([
+        "TEMP_FILE=\"$$(mktemp -t bazel.XXXXXXXX)\"",
+        "cp \"$(location :build-runfiles_orig)\" \"$${TEMP_FILE}\"",
+        "termux-elf-cleaner --api-level=24 \"$${TEMP_FILE}\"",
+        "cp \"$${TEMP_FILE}\" \"$@\"",
+        "rm \"$${TEMP_FILE}\"",
+    ]),
+)
+
 cc_binary(
-    name = "linux-sandbox",
+    name = "linux-sandbox_orig",
     srcs = select({
         "//src/conditions:darwin": ["dummy-sandbox.c"],
         "//src/conditions:freebsd": ["dummy-sandbox.c"],
@@ -110,6 +155,21 @@ cc_binary(
     }),
 )
 
+genrule(
+    name = "linux-sandbox_cleaner",
+    srcs = [
+        ":linux-sandbox_orig",
+    ],
+    outs = ["linux-sandbox"],
+    cmd = "\n".join([
+        "TEMP_FILE=\"$$(mktemp -t bazel.XXXXXXXX)\"",
+        "cp \"$(location :linux-sandbox_orig)\" \"$${TEMP_FILE}\"",
+        "termux-elf-cleaner --api-level=24 \"$${TEMP_FILE}\"",
+        "cp \"$${TEMP_FILE}\" \"$@\"",
+        "rm \"$${TEMP_FILE}\"",
+    ]),
+)
+
 exports_files([
     "build_interface_so",
 ])
